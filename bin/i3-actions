#!/usr/bin/env bash


EXTERNAL_DEVICE=$(xrandr | grep connected | grep -v 'disconnected' | grep -v primary | cut -d ' ' -f 1)
PRIMARY_DEVICE=$(xrandr | grep connected | grep -v 'disconnected' | grep primary | cut -d ' ' -f 1)

BATTERY_NOTIFY_HOME=${HOME}/.config/i3/battery-notify
BATTERY_NOTIFY_PROCESS=battery-notify
BATTERY_NOTIFY_PID=$(pgrep ${BATTERY_NOTIFY_PROCESS})

SERVICES_CMD="${HOME}/.config/i3/bin/i3-services"

menu="swapcaps: Swap Caps Lock as Esc
restorecaps: Restore Caps Lock
kbdlayoutintl: Keyboard layout AltGr Intl
notifyoff: Disable system notifications
notifyon: Enable system notifications
notifyhist: Pop notification from history
i3-toexternal: Move current container to external output device (${EXTERNAL_DEVICE})
i3-toprimary: Move current container to primary output device (${PRIMARY_DEVICE})
i3-window-toexternal: Move current window to external output device (${EXTERNAL_DEVICE})
i3-window-toprimary: Move current window to primary output device (${PRIMARY_DEVICE})
battery-notify-on: Activate or show current battery-notify process (pid:${BATTERY_NOTIFY_PID})
battery-notify-off: Kill current battery-notify process (pid:${BATTERY_NOTIFY_PID})
battery-notify-status: Kill current battery-notify process (pid:${BATTERY_NOTIFY_PID})
settings-workspace: Creates settings workspace
services-restart: Restart a system daemon
services-status: Restart a system daemon
"

action=$(echo -e "$menu" | rofi -width 500 -dmenu -p Actions: | cut -d ':' -f 1)

case $action in
    swapcaps)
        setxkbmap -option caps:escape
        notify-send -u low -t 1000 "Actions" "Caps Lock as escape"
        ;;
    restorecaps)
        setxkbmap -option caps:caps
        notify-send -u low -t 1000 "Actions" "Caps Lock restored"
        ;;
    kbdlayoutintl)
        setxkbmap -model pc105 -layout us -variant altgr-intl
        notify-send -u low -t 1000 "Actions" "Set keyboard layout to US AltGr Intl"
        ;;
    notifyon)
        dunstctl set-paused false
        notify-send -u low -t 1000 "Actions" "Notifications enabled"
        ;;
    notifyoff)
        dunstctl set-paused true
        ;;
    notifyhist)
        dunstctl history-pop
        ;;
    i3-toexternal)
        i3-msg move workspace to output ${EXTERNAL_DEVICE}
        ;;
    i3-toprimary)
        i3-msg move workspace to output primary
        ;;
    i3-window-toexternal)
        i3-msg move window to output ${EXTERNAL_DEVICE}
        ;;
    i3-window-toprimary)
        i3-msg move window to output primary
        ;;
    settings-workspace)
        i3-msg workspace "10:ðŸ”©"
        gtk-launch blueman-manager
        gtk-launch pavucontrol
        ;;
    battery-notify-on)
        pgrep ${BATTERY_NOTIFY_PROCESS}
        pkill "${BATTERY_NOTIFY_PROCESS}"
        cd ${BATTERY_NOTIFY_HOME} && ./battery-notify-watch.sh
        pid=$(pgrep ${BATTERY_NOTIFY_PROCESS})
        notify-send -u normal -t 1000 "Actions" "battery-notify started (pid:$pid) "
        ;;
    battery-notify-off)
        pkill "${BATTERY_NOTIFY_PROCESS}"
        pid=$(pgrep ${BATTERY_NOTIFY_PROCESS})
        notify-send -u low -t 1000 "Actions" "battery-notify killed (pid:$pid) "
        ;;
    battery-notify-status)
        pid=$(pgrep ${BATTERY_NOTIFY_PROCESS})
        running=$(pgrep ${BATTERY_NOTIFY_PROCESS} > /dev/null && echo "Running")
        status="
status: ${running}
pid: ${pid}

logs:
$(tail ${BATTERY_NOTIFY_HOME}/*.log)
"
        action=$(echo -e "$status" | rofi -width 800 -dmenu -p "${BATTERY_NOTIFY_PROCESS} status:" | cut -d ':' -f 1)
        ;;
    services-restart)
        ${SERVICES_CMD} restart
        ;;
    services-status)
        ${SERVICES_CMD} status
        ;;
esac
